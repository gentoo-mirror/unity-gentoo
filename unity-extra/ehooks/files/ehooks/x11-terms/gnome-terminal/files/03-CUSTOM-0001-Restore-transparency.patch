From: Debarshi Ray <debarshir@gnome.org>
Date: Mon, 12 May 2014 14:57:18 +0200
Subject: [PATCH] Restore transparency

The transparency settings were removed as a side effect of
2bff4b63ed3ceef6055e35563e9b0b33ad57349d

This restores them and you will need a compositing window manager to
use it. The background image setting, also known as faux transparency,
was not restored.

Also contains

326c4f143511a3fae61aed1466568260a2ac1c4e Mon Sep 17 00:00:00 2001
Lars Uebernickel <lars.uebernickel@canonical.com>
Wed, 28 May 2014 14:11:02 +0200
[PATCH] window: Make the drawing robust across all themes

There are lots of themes out there in the wild that do not specify a
background-color for all widgets and the default is transparent. This
is usually not a problem because GTK+ sets an opaque region on the
whole window and things without a background-color get drawn with the
theme's default background colour. However, to achieve transparency
we disable the opaque region by making the window app-paintable. This
can lead to transparent menubars or notebook tabs in some themes. We
can avoid this by ensuring that the window always renders a background.

https://bugzilla.gnome.org/show_bug.cgi?id=730016
---
 src/org.gnome.Terminal.gschema.xml |  6 ++-
 src/preferences.ui                 | 89 +++++++++++++++++++++++++++++++++++---
 src/profile-editor.c               | 29 +++++++------
 src/terminal-schemas.h             |  1 +
 src/terminal-screen.c              | 35 ++++++++++++---
 src/terminal-window.c              | 18 +++-----
 6 files changed, 141 insertions(+), 37 deletions(-)

diff --git a/src/org.gnome.Terminal.gschema.xml b/src/org.gnome.Terminal.gschema.xml
index 3e07770..e326b1b 100644
--- a/src/org.gnome.Terminal.gschema.xml
+++ b/src/org.gnome.Terminal.gschema.xml
@@ -421,9 +421,13 @@
       <default>false</default>
       <summary>Whether to use a transparent background</summary>
     </key>
+    <key name="use-theme-transparency" type="b">
+      <default>true</default>
+      <summary>Whether to use the value of TerminalScreen-background-darkness,
+          if available, from the theme for the transparency value.</summary>
+    </key>
     <key name="background-transparency-percent" type="i">
       <default>50</default>
-      <range min="0" max="100"/>
       <summary>Adjust the amount of transparency</summary>
       <description>A value between 0 and 100, where 0 is opaque and 100 is fully transparent.</description>
     </key>
diff --git a/src/preferences.ui b/src/preferences.ui
index 0dddd9b..f410e7f 100644
--- a/src/preferences.ui
+++ b/src/preferences.ui
@@ -100,6 +100,11 @@
       </row>
     </data>
   </object>
+  <object class="GtkAdjustment" id="background-transparent-adjustment">
+    <property name="upper">100</property>
+    <property name="step_increment">1</property>
+    <property name="page_increment">10</property>
+  </object>
   <object class="GtkListStore" id="model1">
     <columns>
       <!-- column-name gchararray -->
@@ -1330,7 +1335,7 @@
                                             <property name="spacing">12</property>
                                             <child>
                                               <object class="GtkCheckButton" id="use-transparent-background">
-                                                <property name="label" translatable="yes">Transparent background</property>
+                                                <property name="label" translatable="yes">Use t_ransparent background</property>
                                                 <property name="visible">True</property>
                                                 <property name="can_focus">True</property>
                                                 <property name="receives_default">False</property>
@@ -1345,11 +1350,56 @@
                                               </packing>
                                             </child>
                                             <child>
-                                              <object class="GtkScale" id="background-transparent-scale">
+                                              <object class="GtkBox" id="background-transparent-scale-box">
                                                 <property name="visible">True</property>
-                                                <property name="can_focus">True</property>
-                                                <property name="adjustment">background-transparent-adjustment</property>
-                                                <property name="draw_value">False</property>
+                                                <property name="can_focus">False</property>
+                                                <property name="orientation">horizontal</property>
+                                                <property name="spacing">6</property>
+                                                <child>
+                                                  <object class="GtkLabel" id="background-transparent-min-label">
+                                                    <property name="visible">True</property>
+                                                    <property name="can_focus">False</property>
+                                                    <property name="xalign">0.5</property>
+                                                    <property name="label" translatable="yes">none</property>
+                                                    <style>
+                                                      <class name="dim-label"/>
+                                                    </style>
+                                                  </object>
+                                                  <packing>
+                                                    <property name="expand">False</property>
+                                                    <property name="fill">False</property>
+                                                    <property name="position">0</property>
+                                                  </packing>
+                                                </child>
+                                                <child>
+                                                  <object class="GtkScale" id="background-transparent-scale">
+                                                    <property name="visible">True</property>
+                                                    <property name="can_focus">True</property>
+                                                    <property name="adjustment">background-transparent-adjustment</property>
+                                                    <property name="draw_value">False</property>
+                                                  </object>
+                                                  <packing>
+                                                    <property name="expand">True</property>
+                                                    <property name="fill">True</property>
+                                                    <property name="position">1</property>
+                                                  </packing>
+                                                </child>
+                                                <child>
+                                                  <object class="GtkLabel" id="background-transparent-max-label">
+                                                    <property name="visible">True</property>
+                                                    <property name="can_focus">False</property>
+                                                    <property name="xalign">0.5</property>
+                                                    <property name="label" translatable="yes">full</property>
+                                                    <style>
+                                                      <class name="dim-label"/>
+                                                    </style>
+                                                  </object>
+                                                  <packing>
+                                                    <property name="expand">False</property>
+                                                    <property name="fill">False</property>
+                                                    <property name="position">2</property>
+                                                  </packing>
+                                                </child>
                                               </object>
                                               <packing>
                                                 <property name="expand">True</property>
@@ -1364,6 +1414,35 @@
                                             <property name="position">2</property>
                                           </packing>
                                         </child>
+                                        <child>
+                                          <object class="GtkBox" id="use-theme-transparency-box">
+                                            <property name="visible">True</property>
+                                            <property name="can_focus">False</property>
+                                            <property name="orientation">horizontal</property>
+                                            <property name="spacing">12</property>
+                                            <child>
+                                              <object class="GtkCheckButton" id="use-theme-transparency-checkbutton">
+                                                <property name="label" translatable="yes">Use transparency from system theme</property>
+                                                <property name="visible">True</property>
+                                                <property name="can_focus">True</property>
+                                                <property name="receives_default">False</property>
+                                                <property name="use_underline">True</property>
+                                                <property name="xalign">0</property>
+                                                <property name="draw_indicator">True</property>
+                                              </object>
+                                              <packing>
+                                                <property name="expand">False</property>
+                                                <property name="fill">False</property>
+                                                <property name="position">0</property>
+                                              </packing>
+                                            </child>
+                                          </object>
+                                          <packing>
+                                            <property name="expand">True</property>
+                                            <property name="fill">True</property>
+                                            <property name="position">3</property>
+                                          </packing>
+                                        </child>
                                       </object>
                                     </child>
                                   </object>
diff --git a/src/profile-editor.c b/src/profile-editor.c
index 4f0b6bb..38e84cd 100644
--- a/src/profile-editor.c
+++ b/src/profile-editor.c
@@ -1269,21 +1269,24 @@ profile_prefs_load (const char *uuid, GSettings *profile)
                                "active-id",
                                G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
 
-  profile_prefs_settings_bind (profile,
-                               TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND,
+  profile_prefs_settings_bind (profile, TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND,
                                gtk_builder_get_object (builder, "use-transparent-background"),
-                               "active",
-                               G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
-  profile_prefs_settings_bind (profile,
-                               TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND,
-                               gtk_builder_get_object (builder, "background-transparent-scale"),
-                               "sensitive",
-                               G_SETTINGS_BIND_GET | G_SETTINGS_BIND_NO_SENSITIVITY);
-  profile_prefs_settings_bind (profile,
-                               TERMINAL_PROFILE_BACKGROUND_TRANSPARENCY_PERCENT,
+                               "active", G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
+  profile_prefs_settings_bind (profile, TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND,
+                               gtk_builder_get_object (builder, "background-transparent-scale-box"),
+                               "sensitive", G_SETTINGS_BIND_GET | G_SETTINGS_BIND_NO_SENSITIVITY);
+  profile_prefs_settings_bind (profile, TERMINAL_PROFILE_BACKGROUND_TRANSPARENCY_PERCENT,
                                gtk_builder_get_object (builder, "background-transparent-adjustment"),
-                               "value",
-                               G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
+                               "value", G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
+  profile_prefs_settings_bind (profile, TERMINAL_PROFILE_USE_THEME_TRANSPARENCY,
+                               gtk_builder_get_object (builder, "use-theme-transparency-checkbutton"),
+                               "active", G_SETTINGS_BIND_GET | G_SETTINGS_BIND_SET);
+  profile_prefs_settings_bind (profile, TERMINAL_PROFILE_USE_THEME_TRANSPARENCY,
+                               gtk_builder_get_object (builder, "use-transparent-background-box"),
+                               "sensitive",
+                               G_SETTINGS_BIND_GET |
+                               G_SETTINGS_BIND_INVERT_BOOLEAN |
+                               G_SETTINGS_BIND_NO_SENSITIVITY);
 }
 
 /* Called once per Preferences window, to destroy stuff that doesn't depend on the profile being edited */
diff --git a/src/terminal-schemas.h b/src/terminal-schemas.h
index af5d884..2aa467a 100644
--- a/src/terminal-schemas.h
+++ b/src/terminal-schemas.h
@@ -76,6 +76,7 @@ G_BEGIN_DECLS
 #define TERMINAL_PROFILE_WORD_CHAR_EXCEPTIONS_KEY       "word-char-exceptions"
 
 #define TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND      "use-transparent-background"
+#define TERMINAL_PROFILE_USE_THEME_TRANSPARENCY          "use-theme-transparency"
 #define TERMINAL_PROFILE_BACKGROUND_TRANSPARENCY_PERCENT "background-transparency-percent"
 
 #define TERMINAL_SETTING_CONFIRM_CLOSE_KEY              "confirm-close"
diff --git a/src/terminal-screen.c b/src/terminal-screen.c
index 324fce7..90da51f 100644
--- a/src/terminal-screen.c
+++ b/src/terminal-screen.c
@@ -592,6 +592,11 @@ terminal_screen_class_init (TerminalScreenClass *klass)
 
   g_type_class_add_private (object_class, sizeof (TerminalScreenPrivate));
 
+  gtk_widget_class_install_style_property (widget_class,
+     g_param_spec_float ("background-darkness", NULL, NULL, -1, 1, -1,
+                         G_PARAM_READABLE | G_PARAM_STATIC_NAME | G_PARAM_STATIC_NICK | G_PARAM_STATIC_BLURB));
+
+
   n_url_regexes = G_N_ELEMENTS (url_regex_patterns);
   precompile_regexes (url_regex_patterns, n_url_regexes, &url_regexes, &url_regex_flavors);
   n_extra_regexes = G_N_ELEMENTS (extra_regex_patterns);
@@ -991,7 +996,8 @@ terminal_screen_profile_changed_cb (GSettings     *profile,
       prop_name == I_(TERMINAL_PROFILE_HIGHLIGHT_FOREGROUND_COLOR_KEY) ||
       prop_name == I_(TERMINAL_PROFILE_PALETTE_KEY) ||
       prop_name == I_(TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND) ||
-      prop_name == I_(TERMINAL_PROFILE_BACKGROUND_TRANSPARENCY_PERCENT))
+      prop_name == I_(TERMINAL_PROFILE_BACKGROUND_TRANSPARENCY_PERCENT) ||
+      prop_name == I_(TERMINAL_PROFILE_USE_THEME_TRANSPARENCY))
     update_color_scheme (screen);
 
   if (!prop_name || prop_name == I_(TERMINAL_PROFILE_AUDIBLE_BELL_KEY))
@@ -1094,8 +1100,10 @@ update_color_scheme (TerminalScreen *screen)
   GdkRGBA *cursor_bgp = NULL, *cursor_fgp = NULL;
   GdkRGBA *highlight_bgp = NULL, *highlight_fgp = NULL;
   GtkStyleContext *context;
-  gboolean transparent;
   gboolean use_theme_colors;
+  GtkWidget *toplevel;
+  gboolean transparent, theme_transparent;
+  gfloat style_darkness;
 
   context = gtk_widget_get_style_context (widget);
   gtk_style_context_get_color (context, gtk_style_context_get_state (context), &theme_fg);
@@ -1136,9 +1144,18 @@ update_color_scheme (TerminalScreen *screen)
     }
 
   colors = terminal_g_settings_get_rgba_palette (priv->profile, TERMINAL_PROFILE_PALETTE_KEY, &n_colors);
-
+  theme_transparent = g_settings_get_boolean (profile, TERMINAL_PROFILE_USE_THEME_TRANSPARENCY);
   transparent = g_settings_get_boolean (profile, TERMINAL_PROFILE_USE_TRANSPARENT_BACKGROUND);
-  if (transparent)
+
+  gtk_widget_style_get (GTK_WIDGET (screen),
+                        "background-darkness", &style_darkness,
+                        NULL);
+
+  if (theme_transparent && style_darkness >= 0)
+    {
+      bg.alpha = style_darkness;
+    }
+  else if (transparent)
     {
       gint transparency_percent;
 
@@ -1146,7 +1163,11 @@ update_color_scheme (TerminalScreen *screen)
       bg.alpha = (100 - transparency_percent) / 100.0;
     }
   else
-    bg.alpha = 1.0;
+      bg.alpha = 1.0;
+
+  /* If this gets out of range, let's not crash */
+  if (bg.alpha < 0.0 || bg.alpha > 1.0)
+      bg.alpha = 1.0;
 
   vte_terminal_set_colors (VTE_TERMINAL (screen), &fg, &bg,
                            colors, n_colors);
@@ -1168,7 +1189,9 @@ update_color_scheme (TerminalScreen *screen)
       g_object_notify (G_OBJECT (screen), "fg-color");
     }
 
-  update_toplevel_transparency (screen);
+  toplevel = gtk_widget_get_toplevel (GTK_WIDGET (screen));
+  if (toplevel != NULL && gtk_widget_is_toplevel (toplevel))
+    gtk_widget_set_app_paintable (toplevel, transparent);
 }
 
 static void
diff --git a/src/terminal-window.c b/src/terminal-window.c
index 37bbcca..00e252e 100644
--- a/src/terminal-window.c
+++ b/src/terminal-window.c
@@ -2030,21 +2030,15 @@ terminal_window_draw (GtkWidget *widget,
 {
   if (gtk_widget_get_app_paintable (widget))
     {
-      GtkAllocation child_allocation;
       GtkStyleContext *context;
-      GtkWidget *child;
-
-      /* Get the *child* allocation, so we don't overwrite window borders */
-      child = gtk_bin_get_child (GTK_BIN (widget));
-      gtk_widget_get_allocation (child, &child_allocation);
+      int width;
+      int height;
 
       context = gtk_widget_get_style_context (widget);
-      gtk_render_background (context, cr,
-                             child_allocation.x, child_allocation.y,
-                             child_allocation.width, child_allocation.height);
-      gtk_render_frame (context, cr,
-                        child_allocation.x, child_allocation.y,
-                        child_allocation.width, child_allocation.height);
+      width = gtk_widget_get_allocated_width (widget);
+      height = gtk_widget_get_allocated_height (widget);
+      gtk_render_background (context, cr, 0, 0, width, height);
+      gtk_render_frame (context, cr, 0, 0, width, height);
     }
 
   return GTK_WIDGET_CLASS (terminal_window_parent_class)->draw (widget, cr);
