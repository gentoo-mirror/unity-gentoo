Subject: [PATCH 1/2] Add a traditional menu bar (v3.28.2)
Bug: https://bugzilla.gnome.org/749976
Bug-Debian: https://bugs.debian.org/793445
---
 data/meson.build      |  1 +
 po/POTFILES.in        |  1 +
 src/eog-application.c | 35 ++++++++++++++++++++++++++++
 src/eog-window.c      | 53 ++++++++++++++++++++++++-------------------
 src/eog.gresource.xml |  1 +
 5 files changed, 68 insertions(+), 23 deletions(-)

diff --git a/data/meson.build b/data/meson.build
index 378863a..71f97d7 100644
--- a/data/meson.build
+++ b/data/meson.build
@@ -2,6 +2,7 @@ subdir('icons')
 
 resource_data = files(
   'pixmaps/thumbnail-frame.png',
+  'eog-menubar.ui',
   'eog-gear-menu.ui',
   'eog-image-properties-dialog.ui',
   'eog-multiple-save-as-dialog.ui',
diff --git a/po/POTFILES.in b/po/POTFILES.in
index 0d602a2..74891d3 100644
--- a/po/POTFILES.in
+++ b/po/POTFILES.in
@@ -4,6 +4,7 @@ data/eog.appdata.xml.in
 data/eog.desktop.in.in
 data/eog-gear-menu.ui
 data/eog-image-properties-dialog.ui
+data/eog-menubar.ui
 data/eog-multiple-save-as-dialog.ui
 data/eog-preferences-dialog.ui
 data/eog-zoom-entry.ui
diff --git a/src/eog-application.c b/src/eog-application.c
index 95ca9ac..95bbebe 100644
--- a/src/eog-application.c
+++ b/src/eog-application.c
@@ -267,6 +267,29 @@ on_extension_removed (PeasExtensionSet *set,
 	eog_application_activatable_deactivate (EOG_APPLICATION_ACTIVATABLE (exten));
 }
 
+static gboolean
+in_desktop (const gchar *name)
+{
+	const gchar *desktop_name_list;
+	gchar **names;
+	gboolean in_list = FALSE;
+	gint i;
+
+	desktop_name_list = g_getenv ("XDG_CURRENT_DESKTOP");
+	if (!desktop_name_list)
+		return FALSE;
+
+	names = g_strsplit (desktop_name_list, ":", -1);
+	for (i = 0; names[i] && !in_list; i++)
+		if (strcmp (names[i], name) == 0) {
+			in_list = TRUE;
+			break;
+		}
+	g_strfreev (names);
+
+	return in_list;
+}
+
 static void
 eog_application_startup (GApplication *application)
 {
@@ -329,6 +352,18 @@ eog_application_startup (GApplication *application)
 			  G_CALLBACK (on_extension_removed), app);
 
 	peas_extension_set_call (app->priv->extensions, "activate");
+
+	if (!in_desktop("GNOME"))
+	{
+		GtkBuilder *builder;
+		builder = gtk_builder_new_from_resource ("/org/gnome/eog/gtk/menu/menus-traditional.ui");
+
+		gtk_application_set_app_menu (GTK_APPLICATION (application), NULL);
+		gtk_application_set_menubar (GTK_APPLICATION (application),
+									G_MENU_MODEL (gtk_builder_get_object (builder, "menubar")));
+
+		g_object_unref (builder);
+	}
 }
 
 static void
diff --git a/src/eog-window.c b/src/eog-window.c
index 775eb72..3c100b7 100644
--- a/src/eog-window.c
+++ b/src/eog-window.c
@@ -4303,23 +4303,36 @@ eog_window_construct_ui (EogWindow *window)
 	gtk_widget_show (priv->zoom_scale);
 #endif
 
-	menu_button = gtk_menu_button_new ();
-	menu_image = gtk_image_new_from_icon_name ("open-menu-symbolic",
-						   GTK_ICON_SIZE_BUTTON);
-	gtk_button_set_image (GTK_BUTTON (menu_button), menu_image);
+	priv->open_with_menu = g_menu_new ();
+	priv->appinfo = g_ptr_array_new_with_free_func (g_object_unref);
+
+	if (in_desktop ("GNOME")) {
+		menu_button = gtk_menu_button_new ();
+		menu_image = gtk_image_new_from_icon_name ("open-menu-symbolic",
+							   GTK_ICON_SIZE_BUTTON);
+		gtk_button_set_image (GTK_BUTTON (menu_button), menu_image);
+
+		builder = gtk_builder_new_from_resource ("/org/gnome/eog/ui/eog-gear-menu.ui");
+		builder_object = gtk_builder_get_object (builder, "gear-menu");
+		gtk_menu_button_set_menu_model (GTK_MENU_BUTTON (menu_button),
+						G_MENU_MODEL (builder_object));
 
-	builder = gtk_builder_new_from_resource ("/org/gnome/eog/ui/eog-gear-menu.ui");
-	builder_object = gtk_builder_get_object (builder, "gear-menu");
-	gtk_menu_button_set_menu_model (GTK_MENU_BUTTON (menu_button),
-					G_MENU_MODEL (builder_object));
+		gtk_header_bar_pack_end (GTK_HEADER_BAR (headerbar), menu_button);
+		gtk_widget_show (menu_button);
+
+		builder_object = gtk_builder_get_object (builder, "open-with-menu");
+		g_menu_append_section (G_MENU (builder_object),
+				       NULL,
+				       G_MENU_MODEL (priv->open_with_menu));
+		priv->gear_menu_builder = builder;
+		builder = NULL;
 
-	gtk_header_bar_pack_end (GTK_HEADER_BAR (headerbar), menu_button);
-	gtk_widget_show (menu_button);
+		action = G_ACTION (g_property_action_new ("toggle-gear-menu",
+							  menu_button, "active"));
+		g_action_map_add_action (G_ACTION_MAP (window), action);
+		g_object_unref (action);
 
-	action = G_ACTION (g_property_action_new ("toggle-gear-menu",
-						  menu_button, "active"));
-	g_action_map_add_action (G_ACTION_MAP (window), action);
-	g_object_unref (action);
+	}
 
 	fullscreen_button = gtk_button_new_from_icon_name ("view-fullscreen-symbolic",
 							   GTK_ICON_SIZE_BUTTON);
@@ -4330,15 +4343,6 @@ eog_window_construct_ui (EogWindow *window)
 	gtk_header_bar_pack_end (GTK_HEADER_BAR (headerbar), fullscreen_button);
 	gtk_widget_show (fullscreen_button);
 
-	priv->open_with_menu = g_menu_new ();
-	priv->appinfo = g_ptr_array_new_with_free_func (g_object_unref);
-	builder_object = gtk_builder_get_object (builder, "open-with-menu");
-	g_menu_append_section (G_MENU (builder_object),
-			       NULL,
-			       G_MENU_MODEL (priv->open_with_menu));
-	priv->gear_menu_builder = builder;
-	builder = NULL;
-
 	priv->cbox = gtk_box_new (GTK_ORIENTATION_VERTICAL, 0);
 	gtk_box_pack_start (GTK_BOX (priv->box), priv->cbox, TRUE, TRUE, 0);
 	gtk_widget_show (priv->cbox);
@@ -5310,6 +5314,9 @@ eog_window_get_gear_menu_section (EogWindow *window, const gchar *id)
 	GObject *object;
 	g_return_val_if_fail (EOG_IS_WINDOW (window), NULL);
 
+	if (window->priv->gear_menu_builder == NULL)
+		return NULL;
+
 	object = gtk_builder_get_object (window->priv->gear_menu_builder, id);
 	if (object == NULL || !G_IS_MENU (object))
 		return NULL;
diff --git a/src/eog.gresource.xml b/src/eog.gresource.xml
index 472408a..0305a13 100644
--- a/src/eog.gresource.xml
+++ b/src/eog.gresource.xml
@@ -13,6 +13,7 @@
     <file compressed="true" preprocess="xml-stripblanks">popup-menus.ui</file>
   </gresource>
   <gresource prefix="/org/gnome/eog/gtk">
+    <file alias="menu/menus-traditional.ui" compressed="true" preprocess="xml-stripblanks">eog-menubar.ui</file>
     <file compressed="true" preprocess="xml-stripblanks">help-overlay.ui</file>
   </gresource>
 </gresources>
-- 
2.24.1

